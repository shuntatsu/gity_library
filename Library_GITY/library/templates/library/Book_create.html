<!doctype html>
<html lang="ja">
<head>
    <!-- このページは開発者用本登録ページです -->
    <meta charset="utf-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
</head>

<body class="container">
    <h1 class="display-4 text-primary" id="targetElementId">{{ title }}</h1>

    <form  action="{% url 'book_create' %}" method="post">
        {% csrf_token %}
        <table class="table">
            {{ form.as_table }}
            <tr>
                <th>
                    <input type="submit" value="click" name="save" class="btn btn-primary mt-2">
                </th>
            </tr>
        </table>
    </form>

    <!-- JavaScriptコードを追加 -->
    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const BarCode = urlParams.get('barcode');
        const QrCode = urlParams.get('qrcode');

        // 書籍情報を取得する関数
        function fetchBookInfo() {
            // リクエストデータを作成
            const requestData = {
                barcode: BarCode, // バーコード
                qrcode: QrCode // QRコード
            };

            // Fetch APIを使用してサーバーにリクエストを送信
            fetch('book_create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData) // リクエストデータをJSON形式に変換して送信
            })
            .then(response => {
                // レスポンスのJSONデータを解析
                return response.json();
            })
            .then(data => {
                // 書籍情報を取得して表示
                console.log(data);
                // ここで書籍情報を取得して、適切な処理を行う
                if (data) {
                    // ページ上に書籍情報を表示するための処理を追加
                    
                    const bookInfoDiv = document.createElement('div');
                    bookInfoDiv.innerHTML = `
                        <img src="${data.image_link}" alt="書籍画像">
                    `;
                    const targetElement = document.getElementById('targetElementId'); // 挿入する場所の要素を取得する
                    targetElement.appendChild(bookInfoDiv);
                    

                    // フォームに書籍情報を自動入力
                    var bookNameInput = document.getElementById('id_book_name');
                    var authorNameInput = document.getElementById('id_author_name');
                    var descriptionInput = document.getElementById('id_description');
                    var imageLinkInput = document.getElementById('id_image_link');
                    var barCodeInput = document.getElementById('id_bar_code');

                    bookNameInput.value = data.book_name;
                    authorNameInput.value = data.author_name;
                    descriptionInput.value = data.description;
                    imageLinkInput.value = data.image_link;
                    barCodeInput.value = data.bar_code;
                }
            })
            .catch(error => {
                // エラーハンドリング
                console.error('Error fetching book information:', error);
            });
        }
        
        // fetchBookInfo関数を呼び出して書籍情報を取得
        fetchBookInfo();
    </script>
</body>
</html>
